name: deploy be

on:
  push:
    branches:
      - prod
    paths:
      - "apps/server/**"
      - ".github/workflows/cd_be.yml"

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.changes.outputs.server }}
      migrations: ${{ steps.changes.outputs.migrations }}
    steps:
      - name: Checkout for changes
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          # Check if server files changed
          if git diff --name-only HEAD~1 HEAD | grep -E '^apps/server/(src/|package\.json|wrangler\.|bun\.lockb)'; then
            echo "server=true" >> $GITHUB_OUTPUT
          else
            echo "server=false" >> $GITHUB_OUTPUT
          fi

          # Check if migration files changed
          if git diff --name-only HEAD~1 HEAD | grep -E '^apps/server/(drizzle/|migrations/|.*\.sql)'; then
            echo "migrations=true" >> $GITHUB_OUTPUT
          else
            echo "migrations=false" >> $GITHUB_OUTPUT
          fi
  deploy:
    needs: changes
    if: needs.changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            apps/server/node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('apps/server/bun.lockb', 'apps/server/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate and run migrations
        if: needs.changes.outputs.migrations == 'true'
        run: |
          echo "Migration files changed, running migrations..."
          bun drizzle:generate
          bun drizzle:migrate
        env:
          TURSO_DATABASE_URL: ${{ secrets.BE_TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.BE_TURSO_AUTH_TOKEN }}

      - name: Build application
        run: bun run build

      - name: Generate wrangler.jsonc
        run: |
          cat > wrangler.jsonc <<EOF
          {
            "name": "be-bonk-bot",
            "account_id": "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}",
            "main": "src/index.ts",
            "compatibility_date": "$(date +%Y-%m-%d)",
             "compatibility_flags": ["nodejs_compat"],
            "vars": {
              "TURSO_DATABASE_URL": "${{ secrets.BE_TURSO_DATABASE_URL }}",
              "TURSO_AUTH_TOKEN": "${{ secrets.BE_TURSO_AUTH_TOKEN }}",
              "SALT": "${{ secrets.BE_SALT }}",
              "JWT_SECRET": "${{ secrets.BE_JWT_SECRET }}",
              "SOLANA_RPC_URL": "${{ vars.SOLANA_RPC_URL }}",
              "FRONTEND_URL": "${{ vars.FRONTEND_URL }}"
            }
          }
          EOF

      - name: Deploy to Workers
        run: bunx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
